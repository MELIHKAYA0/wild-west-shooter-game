<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Red Dead Web: Final Fix</title>
    <style>
        /* --- CSS AYARLARI --- */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; user-select: none; }
        canvas { display: block; cursor: none; } 
        .hidden { display: none !important; }
        
        /* MenÃ¼ */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(40, 25, 15, 0.96);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; pointer-events: auto; cursor: default;
        }
        h1 { 
            color: #ff8f00; font-size: 80px; margin: 0 0 20px 0; 
            text-shadow: 4px 4px 0 #3e2723, 8px 8px 0 rgba(0,0,0,0.5); 
            text-align: center; letter-spacing: 5px; font-weight: 900;
            animation: floatLogo 3s ease-in-out infinite;
        }
        @keyframes floatLogo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        #nick-input {
            background: rgba(0,0,0,0.7); border: 3px solid #ff8f00; color: #fff; padding: 15px; 
            font-size: 24px; text-align: center; border-radius: 8px; margin-bottom: 20px; 
            width: 350px; outline: none; text-transform: uppercase; font-family: inherit; font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 143, 0, 0.3);
        }

        .btn {
            background: linear-gradient(180deg, #ff8f00, #ff6f00); color: #3e2723; 
            border: 3px solid #3e2723; padding: 15px 50px; font-size: 22px; font-weight: 900; 
            cursor: pointer; margin: 10px; min-width: 300px; transition: 0.2s; font-family: inherit;
            box-shadow: 0 10px 0 #3e2723, 0 15px 20px rgba(0,0,0,0.4); border-radius: 5px; position: relative; top: 0;
        }
        .btn:hover { background: linear-gradient(180deg, #ffca28, #ff8f00); top: -2px; box-shadow: 0 12px 0 #3e2723, 0 20px 25px rgba(0,0,0,0.4); }
        .btn:active { top: 10px; box-shadow: 0 0 0 #3e2723; }
        
        .btn-back { background: linear-gradient(180deg, #5d4037, #3e2723); color: #ccc; border-color: #3e2723; }
        .btn-back:hover { background: linear-gradient(180deg, #795548, #4e342e); }

        /* BAYRAKLAR (UK BAYRAÄI EKLENDÄ°) */
        .lang-flags { display: flex; gap: 20px; margin-bottom: 30px; }
        .flag-box {
            width: 60px; height: 40px; border: 3px solid #555; cursor: pointer;
            transition: 0.3s; opacity: 0.5; position: relative; box-shadow: 0 5px 10px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .flag-box:hover, .flag-box.active { transform: scale(1.2); opacity: 1; border-color: #ffca28; }
        
        /* TÃ¼rk BayraÄŸÄ± */
        .flag-tr { background-color: #E30A17; }
        .flag-tr::after { content: "â˜¾â˜…"; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; }
        
        /* Ä°ngiltere (BirleÅŸik KrallÄ±k) BayraÄŸÄ± (YENÄ°) */
        .flag-uk {
            background-color: #012169; /* Mavi Zemin */
            /* Beyaz Ã‡aprazlar */
            background-image: 
                linear-gradient(45deg, transparent 45%, #FFFFFF 45%, #FFFFFF 55%, transparent 55%),
                linear-gradient(135deg, transparent 45%, #FFFFFF 45%, #FFFFFF 55%, transparent 55%),
                /* KÄ±rmÄ±zÄ± Ã‡aprazlar (BeyazÄ±n ÃœstÃ¼ne) */
                linear-gradient(45deg, transparent 47%, #C8102E 47%, #C8102E 53%, transparent 53%),
                linear-gradient(135deg, transparent 47%, #C8102E 47%, #C8102E 53%, transparent 53%);
            background-size: 100% 100%;
            background-position: center;
        }
        .flag-uk::before {
            content: "";
            position: absolute; top: 50%; left: 0; width: 100%; height: 20%;
            background: #C8102E; /* Yatay KÄ±rmÄ±zÄ± HaÃ§ */
            transform: translateY(-50%);
            border-top: 3px solid #FFFFFF; border-bottom: 3px solid #FFFFFF; /* Beyaz KenarlÄ±k */
        }
        .flag-uk::after {
            content: "";
            position: absolute; top: 0; left: 50%; width: 15%; height: 100%;
            background: #C8102E; /* Dikey KÄ±rmÄ±zÄ± HaÃ§ */
            transform: translateX(-50%);
            border-left: 3px solid #FFFFFF; border-right: 3px solid #FFFFFF; /* Beyaz KenarlÄ±k */
        }
        
        /* Alman BayraÄŸÄ± */
        .flag-de { background: linear-gradient(180deg, #000000 33.3%, #DD0000 33.3%, #DD0000 66.6%, #FFCE00 66.6%); }

        /* NASIL OYNANIR EKRANI */
        .tutorial-content {
            background: rgba(0,0,0,0.7); border: 2px solid #ffca28; padding: 30px; border-radius: 10px;
            max-width: 600px; text-align: left; color: #fff; font-size: 18px; line-height: 1.6;
        }
        .key-badge {
            background: #eee; color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; border-bottom: 3px solid #999;
        }
        .tut-row { margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }

        /* MAÄAZA */
        .shop-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; max-width: 900px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; border: 2px solid #ff8f00; }
        .shop-card { background: #3e2723; border: 2px solid #ffca28; padding: 10px; border-radius: 8px; color: white; text-align: center; width: 150px; position: relative; }
        .buy-btn-wrap { position: relative; display: inline-block; width: 100%; margin-top: 5px; }
        .buy-btn { background: #2e7d32; color: white; border: none; width: 100%; padding: 8px; cursor: pointer; font-weight: bold; font-family: inherit;}
        .buy-btn:hover { background: #1b5e20; }
        .info-tip {
            visibility: hidden; width: 160px; background-color: #ffeb3b; color: #000; text-align: center;
            border-radius: 6px; padding: 10px; position: absolute; z-index: 100;
            bottom: 110%; left: 50%; transform: translateX(-50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.8); font-size: 12px; font-weight: bold;
            opacity: 0; transition: opacity 0.3s; border: 3px solid #ff8f00; pointer-events: none;
        }
        .info-tip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #ff8f00 transparent transparent transparent; }
        .buy-btn-wrap:hover .info-tip { visibility: visible; opacity: 1; }

        /* HUD */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #hud-money { position: absolute; top: 20px; right: 20px; font-size: 36px; color: #ffca28; font-weight: bold; text-shadow: 2px 2px 0 #000; }
        #hud-kills { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 30px; color: #d7ccc8; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px 20px; border-radius: 10px; border: 2px solid #5d4037; }
        #hud-boss { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); width: 400px; display: none; }
        .boss-bar { width: 100%; height: 20px; background: #3e2723; border: 2px solid #fff; }
        .boss-fill { width: 100%; height: 100%; background: #9c27b0; transition: width 0.1s; }
        #hud-bottom-left { position: absolute; bottom: 20px; left: 20px; width: 300px; }
        .hp-fill { width: 100%; height: 25px; background: #d32f2f; border: 2px solid #fff; transition: width 0.2s; }
        #hud-inventory { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; }
        .inv-slot { background: rgba(0,0,0,0.7); border: 2px solid #8d6e63; color: #fff; padding: 10px; border-radius: 5px; text-align: center; width: 65px; }
        .key-hint { font-size: 10px; color: #ffca28; display: block; }
        #status-msg { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); color: #81c784; font-size: 28px; font-weight: bold; text-shadow: 0 0 15px #000; display: none; }
        #save-notify { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: #81c784; font-size: 14px; opacity: 0; transition: opacity 0.5s; background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 5px;}
        #weapon-display { position: absolute; bottom: 100px; right: 20px; color: #03a9f4; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #000; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 5px; }
        
        /* Game Over */
        .go-title { color: #ef5350; font-size: 80px; font-weight: 900; text-shadow: 5px 5px 0 #000; margin: 0 0 20px 0; }
        .go-text { color: #fff; font-size: 28px; margin: 5px; font-weight: bold; text-shadow: 2px 2px 0 #000; }
        .go-highlight { color: #ffca28; font-size: 32px; }
    </style>
</head>
<body>

    <div id="splash-screen" class="screen">
        <h1 id="txt-title">RED DEAD WEB</h1>
        <div class="lang-flags">
            <div class="flag-box flag-tr" onclick="Game.setLang('tr')" id="flag-tr"></div>
            <div class="flag-box flag-uk" onclick="Game.setLang('uk')" id="flag-uk"></div>
            <div class="flag-box flag-de" onclick="Game.setLang('de')" id="flag-de"></div>
        </div>
        <button class="btn" onclick="Game.goToLobby()" id="btn-start-game">OYUNU BAÅLAT</button>
        <button class="btn btn-back" onclick="Game.goToSettings()" id="btn-settings">AYARLAR</button>
        <button class="btn btn-back" onclick="Game.goToTutorial()" id="btn-tutorial">NASIL OYNANIR</button>
    </div>

    <div id="settings-menu" class="screen hidden">
        <h1 style="font-size: 50px;" id="txt-settings">AYARLAR</h1>
        <div class="setting-row">
            <label><span id="txt-sens">NÄ°ÅAN HASSASÄ°YETÄ°</span>: <span id="sens-val">50</span>%</label><br>
            <input type="range" id="sens-slider" min="1" max="100" value="50" oninput="Game.updateSens(this.value)">
        </div>
        <button class="btn btn-back" onclick="Game.backToSplash()" style="margin-top: 40px;" id="btn-back">GERÄ° DÃ–N</button>
    </div>

    <div id="tutorial-menu" class="screen hidden">
        <h1 id="txt-how-title" style="font-size: 50px;">NASIL OYNANIR?</h1>
        <div class="tutorial-content">
            <div class="tut-row"><span class="key-badge">W A S D</span> <span id="hlp-move">Hareket Et</span></div>
            <div class="tut-row"><span class="key-badge">SHIFT</span> <span id="hlp-run">HÄ±zlÄ± KoÅŸ</span></div>
            <div class="tut-row"><span class="key-badge">MOUSE</span> <span id="hlp-aim">NiÅŸan Al & AteÅŸ Et</span></div>
            <div class="tut-row"><span class="key-badge">Q</span> <span id="hlp-switch">Silah DeÄŸiÅŸtir (Varsa)</span></div>
            <div class="tut-row"><span class="key-badge">G</span> <span id="hlp-tnt">Dinamit FÄ±rlat</span></div>
            <div class="tut-row"><span class="key-badge">1</span> / <span class="key-badge">2</span> <span id="hlp-pots">Can / GÃ¼Ã§ Ä°ksiri</span></div>
            <div style="margin-top: 20px; color: #ffca28; font-weight: bold;" id="hlp-goal">AMACIN: Hayatta kal, para biriktir ve en gÃ¼Ã§lÃ¼ kovboy ol!</div>
        </div>
        <button class="btn btn-back" onclick="Game.backToSplash()" style="margin-top: 20px;" id="btn-back-3">GERÄ° DÃ–N</button>
    </div>

    <div id="main-menu" class="screen hidden">
        <h1 id="txt-lobby">KASABA MEYDANI</h1>
        <div style="color:#ffca28; font-size:24px; margin-bottom:15px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px;">
            <span id="txt-bank">KASA</span>: $<span id="menu-money">0</span> | <span id="txt-record">REKOR</span>: <span id="menu-high">0</span>
        </div>
        <input type="text" id="nick-input" placeholder="ADINI YAZ" maxlength="10">
        <button class="btn" onclick="Game.start()" id="btn-play">Ã‡Ã–LE GÄ°R</button>
        <button class="btn" onclick="Game.openShop()" id="btn-shop">SÄ°LAHÃ‡I</button>
        <button class="btn btn-back" onclick="Game.backToSplash()" id="btn-main-menu">ANA EKRAN</button>
        <div id="save-notify">KAYDEDÄ°LDÄ°</div>
    </div>

    <div id="shop-menu" class="screen hidden">
        <h1 id="txt-shop-title">SÄ°LAHÃ‡I</h1>
        <div style="color:#ffca28; margin-bottom:20px; font-size: 24px; background: rgba(0,0,0,0.6); padding: 5px 20px; border-radius: 10px;"><span id="txt-balance">BAKÄ°YE</span>: $<span id="shop-money">0</span></div>
        <div class="shop-container">
            <div class="shop-card">
                <h4 id="item-horse">HIZLI AT</h4><div style="color:#66bb6a">$50</div>
                <div class="buy-btn-wrap"><button class="buy-btn" onclick="Game.buy('speed', 50)" id="btn-buy-1">AL</button><span class="info-tip" id="desc-horse">AtÄ±nÄ±n koÅŸma hÄ±zÄ±nÄ± artÄ±rÄ±r.</span></div>
                <div id="lvl-speed" style="font-size:10px;">Lv: 1</div>
            </div>
            <div class="shop-card" style="border-color:#ff5722">
                <h4 id="item-pierce">DELÄ°CÄ°</h4><div style="color:#ff5722">$150</div>
                <div class="buy-btn-wrap"><button class="buy-btn" onclick="Game.buy('damage', 150)" id="btn-buy-2">GELÄ°ÅTÄ°R</button><span class="info-tip" id="desc-pierce">Mermiler dÃ¼ÅŸman iÃ§inden geÃ§er.</span></div>
                <div id="lvl-damage" style="font-size:10px;">Lv: 1</div>
            </div>
            <div class="shop-card">
                <h4 id="item-rate">SERÄ° TETÄ°K</h4><div style="color:#66bb6a">$150</div>
                <div class="buy-btn-wrap"><button class="buy-btn" onclick="Game.buy('rate', 150)" id="btn-buy-3">AL</button><span class="info-tip" id="desc-rate">AteÅŸ etme hÄ±zÄ±nÄ± artÄ±rÄ±r.</span></div>
                <div id="lvl-rate" style="font-size:10px;">Lv: 1</div>
            </div>
            <div class="shop-card" style="border-color:#03a9f4">
                <h4 id="item-shotgun">POMPALI</h4><div style="color:#03a9f4">$300</div>
                <div class="buy-btn-wrap"><button class="buy-btn" onclick="Game.buy('shotgun', 300)" id="btn-buy-4">AL</button><span class="info-tip" id="desc-shotgun">5 SaÃ§ma atar. [Q] ile deÄŸiÅŸ.</span></div>
                <div id="has-shotgun" style="font-size:10px;">YOK</div>
            </div>
            <div class="shop-card" style="border-color:#ef5350">
                <h4 id="item-hp">CAN</h4><div style="color:#ef5350">$75</div>
                <div class="buy-btn-wrap"><button class="buy-btn" onclick="Game.buy('hpPot', 75)" id="btn-buy-5">AL</button><span class="info-tip" id="desc-hp">CanÄ±nÄ± %100 doldurur. [1] TuÅŸu.</span></div>
                <div id="qty-hp" style="font-size:10px;">0</div>
            </div>
            <div class="shop-card" style="border-color:#ffeb3b">
                <h4 id="item-pwr">GÃœÃ‡</h4><div style="color:#ffeb3b">$125</div>
                <div class="buy-btn-wrap"><button class="buy-btn" onclick="Game.buy('pwrPot', 125)" id="btn-buy-6">AL</button><span class="info-tip" id="desc-pwr">10sn SÃ¼per GÃ¼Ã§. [2] TuÅŸu.</span></div>
                <div id="qty-pwr" style="font-size:10px;">0</div>
            </div>
            <div class="shop-card" style="border-color:#d50000">
                <h4 id="item-tnt">DÄ°NAMÄ°T</h4><div style="color:#d50000">$200</div>
                <div class="buy-btn-wrap"><button class="buy-btn" onclick="Game.buy('dynamite', 200)" id="btn-buy-7">AL</button><span class="info-tip" id="desc-tnt">Alan hasarÄ±. [G] TuÅŸu.</span></div>
                <div id="qty-dyn" style="font-size:10px;">0</div>
            </div>
        </div>
        <button class="btn btn-back" onclick="Game.toMenu()" style="margin-top:20px;" id="btn-back-2">GERÄ°</button>
    </div>

    <div id="game-over" class="screen hidden">
        <h1 class="go-title" id="txt-wasted">MEFTA OLDUN</h1>
        <p class="go-text"><span id="txt-kill-count">LeÅŸ SayÄ±sÄ±</span>: <span id="go-kills" class="go-highlight">0</span></p>
        <p class="go-text"><span id="txt-loot">Ganimet</span>: $<span id="go-money" class="go-highlight">0</span></p>
        <div class="btn-group">
            <button class="btn" onclick="Game.claimAndStart()" id="btn-retry">TEKRAR</button>
            <button class="btn btn-back" onclick="Game.claimAndMenu()" id="btn-menu-go">MENÃœ</button>
            <button class="btn" onclick="Game.claimAndShop()" id="btn-shop-go">MAÄAZA</button>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="hud-top-right"><div id="hud-money">$0</div><div id="hud-score"><span id="txt-score">SKOR</span>: 0</div></div>
        <div id="status-msg"></div>
        <div id="hud-boss"><div style="color:#e040fb; font-weight:bold; text-align:center;" id="txt-boss">Ã‡ETE LÄ°DERÄ°</div><div class="boss-bar"><div class="boss-fill" id="boss-hp-bar"></div></div></div>
        <div id="hud-bottom-left"><div style="color:#3e2723; font-weight:bold; font-size:12px;" id="txt-health">SAÄLIK</div><div class="hp-fill" id="hp-bar"></div></div>
        <div id="hud-inventory">
            <div class="inv-slot" style="border-color:#ef5350;"><span class="key-hint">[1]</span><br><span id="txt-inv-hp">CAN</span><br><b id="hud-hp-count">0</b></div>
            <div class="inv-slot" style="border-color:#ffeb3b;"><span class="key-hint">[2]</span><br><span id="txt-inv-pwr">GÃœÃ‡</span><br><b id="hud-pwr-count">0</b></div>
            <div class="inv-slot" style="border-color:#d50000;"><span class="key-hint">[G]</span><br>TNT<br><b id="hud-dyn-count">0</b></div>
            <div class="inv-slot" style="border-color:#03a9f4;"><span class="key-hint">[Q]</span><br><span id="txt-inv-wep">SÄ°LAH</span><br><b id="hud-weapon">TAB</b></div>
        </div>
        <div id="weapon-display">TABANCA</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        /* --- DÄ°L DOSYALARI (US -> UK DeÄŸiÅŸimi) --- */
        const texts = {
            tr: {
                start: "OYUNU BAÅLAT", settings: "AYARLAR", tutorial: "NASIL OYNANIR", back: "GERÄ° DÃ–N",
                lobby: "KASABA MEYDANI", bank: "KASA", record: "REKOR", play: "Ã‡Ã–LE GÄ°R", shop: "SÄ°LAHÃ‡I", main: "ANA EKRAN",
                balance: "BAKÄ°YE", sens: "NÄ°ÅAN HASSASÄ°YETÄ°", saved: "KAYDEDÄ°LDÄ°",
                items: { horse: "HIZLI AT", pierce: "DELÄ°CÄ°", rate: "SERÄ° TETÄ°K", shotgun: "POMPALI", hp: "CAN", pwr: "GÃœÃ‡", tnt: "DÄ°NAMÄ°T" },
                desc: { horse: "AtÄ±nÄ±n koÅŸma hÄ±zÄ±nÄ± artÄ±rÄ±r.", pierce: "Mermiler dÃ¼ÅŸman iÃ§inden geÃ§er.", rate: "AteÅŸ etme hÄ±zÄ±nÄ± artÄ±rÄ±r.", shotgun: "5 SaÃ§ma atar. [Q] ile deÄŸiÅŸ.", hp: "CanÄ± %100 doldurur. [1]", pwr: "10sn SÃ¼per GÃ¼Ã§. [2]", tnt: "Alan hasarÄ±. [G]" },
                buy: "AL", upgrade: "GELÄ°ÅTÄ°R", wasted: "MEFTA OLDUN", kills: "LeÅŸ SayÄ±sÄ±", loot: "Ganimet",
                retry: "TEKRAR", menu: "MENÃœ", score: "SKOR", boss: "Ã‡ETE LÄ°DERÄ°", health: "SAÄLIK",
                inv: { hp: "CAN", pwr: "GÃœÃ‡", wep: "SÄ°LAH" },
                wepName: { pistol: "TABANCA", shotgun: "POMPALI" },
                status: { power: "GÃœÃ‡ MODU âš¡", stealth: "GÄ°ZLENDÄ°N ğŸ‘ï¸â€ğŸ—¨ï¸" },
                placeholder: "ADINI YAZ KOVBOY",
                howTitle: "NASIL OYNANIR?",
                hlp: { move: "Hareket Et", run: "HÄ±zlÄ± KoÅŸ", aim: "NiÅŸan Al & AteÅŸ", switch: "Silah DeÄŸiÅŸtir", tnt: "Dinamit FÄ±rlat", pots: "Ä°ksirler", goal: "AMACIN: Hayatta kal, para biriktir ve en gÃ¼Ã§lÃ¼ kovboy ol!" }
            },
            uk: { /* UK English */
                start: "START GAME", settings: "SETTINGS", tutorial: "HOW TO PLAY", back: "GO BACK",
                lobby: "TOWN SQUARE", bank: "BANK", record: "RECORD", play: "ENTER DESERT", shop: "GUNSMITH", main: "MAIN MENU",
                balance: "BALANCE", sens: "AIM SENSITIVITY", saved: "GAME SAVED",
                items: { horse: "FAST HORSE", pierce: "PIERCING", rate: "RAPID FIRE", shotgun: "SHOTGUN", hp: "HEALTH", pwr: "POWER", tnt: "DYNAMITE" },
                desc: { horse: "Increases horse speed.", pierce: "Bullets pass through enemies.", rate: "Increases fire rate.", shotgun: "Fires 5 pellets. Press [Q].", hp: "Restores 100% HP. Press [1]", pwr: "10s Super Power. Press [2]", tnt: "Area damage. Press [G]" },
                buy: "BUY", upgrade: "UPGRADE", wasted: "WASTED", kills: "Kills", loot: "Loot",
                retry: "RETRY", menu: "MENU", score: "SCORE", boss: "GANG LEADER", health: "HEALTH",
                inv: { hp: "HP", pwr: "PWR", wep: "GUN" },
                wepName: { pistol: "PISTOL", shotgun: "SHOTGUN" },
                status: { power: "POWER MODE âš¡", stealth: "HIDDEN ğŸ‘ï¸â€ğŸ—¨ï¸" },
                placeholder: "ENTER NAME",
                howTitle: "HOW TO PLAY",
                hlp: { move: "Move Character", run: "Sprint", aim: "Aim & Shoot", switch: "Switch Weapon", tnt: "Throw Dynamite", pots: "Potions", goal: "GOAL: Survive, loot money and become the best cowboy!" }
            },
            de: {
                start: "SPIEL STARTEN", settings: "EINSTELLUNGEN", tutorial: "ANLEITUNG", back: "ZURÃœCK",
                lobby: "STADTPLATZ", bank: "KASSE", record: "REKORD", play: "WÃœSTE BETRETEN", shop: "WAFFEN", main: "HAUPTMENÃœ",
                balance: "GUTHABEN", sens: "ZIEL-SENSITIVITÃ„T", saved: "GESPEICHERT",
                items: { horse: "SCHNELLES PFERD", pierce: "DURCHDRINGEN", rate: "SCHNELLFEUER", shotgun: "SCHROTFLINTE", hp: "LEBEN", pwr: "KRAFT", tnt: "DYNAMIT" },
                desc: { horse: "ErhÃ¶ht die Reitgeschwindigkeit.", pierce: "Kugeln durchdringen Feinde.", rate: "ErhÃ¶ht die Feuerrate.", shotgun: "Feuert 5 SchÃ¼sse. DrÃ¼cke [Q].", hp: "Stellt 100% Leben her. [1]", pwr: "10s Superkraft. [2]", tnt: "FlÃ¤chenschaden. [G]" },
                buy: "KAUFEN", upgrade: "VERBESSERN", wasted: "GESTORBEN", kills: "AbschÃ¼sse", loot: "Beute",
                retry: "WIEHO", menu: "MENÃœ", score: "PUNKTE", boss: "BANDENBOSS", health: "GESUNDHEIT",
                inv: { hp: "HP", pwr: "KRF", wep: "WAFFE" },
                wepName: { pistol: "PISTOLE", shotgun: "FLINTE" },
                status: { power: "POWER MODUS âš¡", stealth: "VERSTECKT ğŸ‘ï¸â€ğŸ—¨ï¸" },
                placeholder: "NAME EINGEBEN",
                howTitle: "SPIELANLEITUNG",
                hlp: { move: "Bewegen", run: "Rennen", aim: "Zielen & SchieÃŸen", switch: "Waffe wechseln", tnt: "Dynamit werfen", pots: "TrÃ¤nke", goal: "ZIEL: Ãœberlebe, sammle Geld und werde zur Legende!" }
            }
        };

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d", { alpha: false });
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- SPRITE Ã‡Ä°ZÄ°MÄ° ---
        const sprites = {};
        function createTextSprite(txt, size, color="white", subTxt="") {
            const c = document.createElement('canvas'); c.width=100; c.height=100;
            const x = c.getContext('2d'); x.textAlign="center"; x.textBaseline="middle";
            if(subTxt) { x.font = (size+10)+"px Arial"; x.fillText(subTxt, 50, 60); x.font = size+"px Arial"; x.fillText(txt, 50, 35); } 
            else { x.font = size+"px Arial"; x.fillStyle = color; x.fillText(txt, 50, 50); }
            return c;
        }
        sprites.player = createTextSprite("ğŸ¤ ", 40, "white", "ğŸ"); 
        sprites.enemy = createTextSprite("ğŸ‘º", 40, "white", "ğŸ");
        sprites.shooter = createTextSprite("ğŸ‘¿", 40, "white", "ğŸ");
        sprites.boss = createTextSprite("ğŸ‘¹", 80);
        sprites.bush = createTextSprite("ğŸŒ³", 80, "#2e7d32");
        sprites.tnt = createTextSprite("ğŸ§¨", 40);
        sprites.cloud = createTextSprite("â˜ï¸", 80, "rgba(255,255,255,0.4)");
        sprites.bird = createTextSprite("ğŸ¦…", 40);

        let saveData = {
            money: 100, highScore: 0, nickname: "KOVBOY", lang: "tr",
            upgrades: { speed: 1, damage: 1, rate: 1, hasShotgun: false },
            inventory: { hpPot: 0, pwrPot: 0, dynamite: 0 },
            sensitivity: 0.5 
        };

        const state = { screen: 'SPLASH', sessionMoney: 0, kills: 0, shake: 0 };
        let player = {};
        let bullets = []; let enemyBullets = []; let enemies = []; let particles = []; let bushes = []; let dynamites = []; let boss = null;
        let mouse = { x: canvas.width/2, y: canvas.height/2, down: false };
        let aim = { x: canvas.width/2, y: canvas.height/2 };
        let crosshair = { recoil: 0 };
        let currentWeapon = 'pistol';
        let lastSpawn = 0;

        const decors = [];
        const menuObjects = [];
        for(let i=0; i<40; i++) decors.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, char: Math.random()>0.8?'ğŸŒµ':(Math.random()>0.5?'ğŸª¨':'.'), size: Math.random()>0.8?30:20 });
        for(let i=0; i<8; i++) menuObjects.push({ type:'cloud', x: Math.random()*canvas.width, y: Math.random()*canvas.height/2, spd: 0.2 + Math.random()*0.3 });
        for(let i=0; i<3; i++) menuObjects.push({ type:'bird', x: Math.random()*canvas.width, y: Math.random()*canvas.height/3, spd: 2 + Math.random() });

        function saveGame() { localStorage.setItem('RDR_WORLD_V2', JSON.stringify(saveData)); document.getElementById('save-notify').innerText = texts[saveData.lang].saved; document.getElementById('save-notify').style.opacity = 1; setTimeout(() => document.getElementById('save-notify').style.opacity = 0, 2000); }
        function loadGame() { 
            const data = localStorage.getItem('RDR_WORLD_V2'); 
            if(data) { saveData = JSON.parse(data); document.getElementById('nick-input').value = saveData.nickname; document.getElementById('sens-slider').value = saveData.sensitivity * 100; }
            if(!saveData.lang) saveData.lang = "tr";
            document.getElementById('sens-val').innerText = Math.round(saveData.sensitivity * 100);
            Game.setLang(saveData.lang);
        }

        const keys = { w:false, a:false, s:false, d:false, shift:false };
        window.addEventListener('keydown', e => {
            const k = e.key.toLowerCase(); if(keys[k] !== undefined) keys[k] = true; if(e.key === "Shift") keys.shift = true;
            if(state.screen === 'GAME') {
                if(k === '1') Game.useItem('hp'); if(k === '2') Game.useItem('pwr'); if(k === 'q') Game.switchWeapon(); if(k === 'g') Game.throwDynamite();
            }
        });
        window.addEventListener('keyup', e => { const k = e.key.toLowerCase(); if(keys[k] !== undefined) keys[k] = false; if(e.key === "Shift") keys.shift = false; });
        window.addEventListener('mousemove', e => { mouse.x=e.clientX; mouse.y=e.clientY; });
        window.addEventListener('mousedown', () => mouse.down = true);
        window.addEventListener('mouseup', () => mouse.down = false);

        const Game = {
            init: () => { loadGame(); requestAnimationFrame(loop); },
            
            // DÄ°L AYARLAMA (US -> UK)
            setLang: (langCode) => {
                saveData.lang = langCode;
                saveGame();
                const t = texts[langCode];
                
                document.querySelectorAll('.flag-box').forEach(b => b.classList.remove('active'));
                document.getElementById('flag-'+langCode).classList.add('active');

                // Ana MenÃ¼
                document.getElementById('btn-start-game').innerText = t.start;
                document.getElementById('btn-settings').innerText = t.settings;
                document.getElementById('btn-tutorial').innerText = t.tutorial;
                document.getElementById('txt-settings').innerText = t.settings;
                document.getElementById('btn-back').innerText = t.back;
                document.getElementById('txt-sens').innerText = t.sens;
                
                document.getElementById('txt-lobby').innerText = t.lobby;
                document.getElementById('txt-bank').innerText = t.bank;
                document.getElementById('txt-record').innerText = t.record;
                document.getElementById('nick-input').placeholder = t.placeholder;
                document.getElementById('btn-play').innerText = t.play;
                document.getElementById('btn-shop').innerText = t.shop;
                document.getElementById('btn-main-menu').innerText = t.main;

                document.getElementById('txt-shop-title').innerText = t.shop;
                document.getElementById('txt-balance').innerText = t.balance;
                document.getElementById('btn-back-2').innerText = t.back;

                // Market
                document.getElementById('item-horse').innerText = t.items.horse; document.getElementById('desc-horse').innerText = t.desc.horse;
                document.getElementById('item-pierce').innerText = t.items.pierce; document.getElementById('desc-pierce').innerText = t.desc.pierce;
                document.getElementById('item-rate').innerText = t.items.rate; document.getElementById('desc-rate').innerText = t.desc.rate;
                document.getElementById('item-shotgun').innerText = t.items.shotgun; document.getElementById('desc-shotgun').innerText = t.desc.shotgun;
                document.getElementById('item-hp').innerText = t.items.hp; document.getElementById('desc-hp').innerText = t.desc.hp;
                document.getElementById('item-pwr').innerText = t.items.pwr; document.getElementById('desc-pwr').innerText = t.desc.pwr;
                document.getElementById('item-tnt').innerText = t.items.tnt; document.getElementById('desc-tnt').innerText = t.desc.tnt;

                document.querySelectorAll('.buy-btn').forEach(b => { if(b.innerText === "AL" || b.innerText === "BUY" || b.innerText === "KAUFEN") b.innerText = t.buy; else b.innerText = t.upgrade; });

                document.getElementById('txt-wasted').innerText = t.wasted;
                document.getElementById('txt-kill-count').innerText = t.kills;
                document.getElementById('txt-loot').innerText = t.loot;
                document.getElementById('btn-retry').innerText = t.retry;
                document.getElementById('btn-menu-go').innerText = t.menu;
                document.getElementById('btn-shop-go').innerText = t.shop;

                document.getElementById('txt-score').innerText = t.score;
                document.getElementById('txt-boss').innerText = t.boss;
                document.getElementById('txt-health').innerText = t.health;
                
                document.getElementById('txt-inv-hp').innerText = t.inv.hp;
                document.getElementById('txt-inv-pwr').innerText = t.inv.pwr;
                document.getElementById('txt-inv-wep').innerText = t.inv.wep;

                // Tutorial
                document.getElementById('txt-how-title').innerText = t.howTitle;
                document.getElementById('hlp-move').innerText = t.hlp.move;
                document.getElementById('hlp-run').innerText = t.hlp.run;
                document.getElementById('hlp-aim').innerText = t.hlp.aim;
                document.getElementById('hlp-switch').innerText = t.hlp.switch;
                document.getElementById('hlp-tnt').innerText = t.hlp.tnt;
                document.getElementById('hlp-pots').innerText = t.hlp.pots;
                document.getElementById('hlp-goal').innerText = t.hlp.goal;
                document.getElementById('btn-back-3').innerText = t.back;
            },

            goToLobby: () => { state.screen = 'MENU'; Game.updateUI(); },
            goToSettings: () => { state.screen = 'SETTINGS'; Game.updateUI(); },
            goToTutorial: () => { state.screen = 'TUTORIAL'; Game.updateUI(); },
            backToSplash: () => { state.screen = 'SPLASH'; Game.updateUI(); },
            toMenu: () => { state.screen = 'MENU'; Game.updateUI(); },
            openShop: () => { state.screen = 'SHOP'; Game.updateUI(); },

            start: () => {
                const nick = document.getElementById('nick-input').value.trim(); if(nick) saveData.nickname = nick; saveGame();
                state.screen = 'GAME'; state.sessionMoney = 0; state.kills = 0; lastSpawn = 0;
                player = {
                    x: canvas.width/2, y: canvas.height/2, hp: 100, maxHp: 100,
                    timer: 0, powerTimer: 0, isHidden: false, revealTimer: 0,
                    spd: 3 + (saveData.upgrades.speed-1)*0.5, dmg: 1, pierce: saveData.upgrades.damage
                };
                aim.x = player.x; aim.y = player.y;
                bullets = []; enemyBullets = []; enemies = []; particles = []; dynamites = []; boss = null;
                bushes = []; for(let i=0; i<6; i++) bushes.push({x: Math.random()*(canvas.width-100)+50, y: Math.random()*(canvas.height-100)+50, r:45});
                Game.updateUI();
            },

            updateSens: (val) => { saveData.sensitivity = val / 100; document.getElementById('sens-val').innerText = val; saveGame(); },

            buy: (type, cost) => {
                if(saveData.money >= cost) {
                    if(type === 'shotgun' && saveData.upgrades.hasShotgun) return;
                    saveData.money -= cost;
                    if(type === 'speed' || type === 'damage' || type === 'rate') saveData.upgrades[type]++;
                    else if(type === 'shotgun') saveData.upgrades.hasShotgun = true;
                    else saveData.inventory[type]++;
                    saveGame(); Game.updateUI();
                } else alert("$$$ !");
            },
            useItem: (type) => {
                if(type === 'hp' && saveData.inventory.hpPot > 0) { saveData.inventory.hpPot--; player.hp = player.maxHp; } 
                else if(type === 'pwr' && saveData.inventory.pwrPot > 0) { saveData.inventory.pwrPot--; player.powerTimer = 600; }
                Game.updateUI();
            },
            switchWeapon: () => { if(saveData.upgrades.hasShotgun) { currentWeapon = (currentWeapon === 'pistol') ? 'shotgun' : 'pistol'; Game.updateUI(); } },
            throwDynamite: () => { if(saveData.inventory.dynamite > 0) { saveData.inventory.dynamite--; dynamites.push({ x: aim.x, y: aim.y, timer: 120 }); Game.updateUI(); } },
            claimAndStart: () => { saveData.money += state.sessionMoney; saveGame(); Game.start(); },
            claimAndMenu: () => { saveData.money += state.sessionMoney; saveGame(); Game.toMenu(); },
            claimAndShop: () => { saveData.money += state.sessionMoney; saveGame(); Game.openShop(); },
            resetSave: () => { if(confirm("???")) { localStorage.removeItem('RDR_WORLD_V2'); location.reload(); } },

            updateUI: () => {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById('ui-layer').classList.add('hidden');

                if(state.screen === 'SPLASH') document.getElementById('splash-screen').classList.remove('hidden');
                else if(state.screen === 'SETTINGS') document.getElementById('settings-menu').classList.remove('hidden');
                else if(state.screen === 'TUTORIAL') document.getElementById('tutorial-menu').classList.remove('hidden');
                else if(state.screen === 'MENU') {
                    document.getElementById('main-menu').classList.remove('hidden');
                    document.getElementById('menu-money').innerText = saveData.money;
                    document.getElementById('menu-high').innerText = saveData.highScore;
                } 
                else if(state.screen === 'SHOP') {
                    document.getElementById('shop-menu').classList.remove('hidden');
                    document.getElementById('shop-money').innerText = saveData.money;
                    document.getElementById('lvl-speed').innerText = "Lv: "+saveData.upgrades.speed;
                    document.getElementById('lvl-damage').innerText = "Lv: "+saveData.upgrades.damage;
                    document.getElementById('lvl-rate').innerText = "Lv: "+saveData.upgrades.rate;
                    document.getElementById('has-shotgun').innerText = saveData.upgrades.hasShotgun ? "OK" : "-";
                    document.getElementById('qty-hp').innerText = saveData.inventory.hpPot;
                    document.getElementById('qty-pwr').innerText = saveData.inventory.pwrPot;
                    document.getElementById('qty-dyn').innerText = saveData.inventory.dynamite;
                }
                else if(state.screen === 'GAME') {
                    document.getElementById('ui-layer').classList.remove('hidden');
                    document.getElementById('hud-money').innerText = "$" + (saveData.money + state.sessionMoney);
                    document.getElementById('hud-score').innerText = texts[saveData.lang].score + ": " + state.kills;
                    document.getElementById('hp-bar').style.width = (player.hp/player.maxHp*100) + "%";
                    document.getElementById('hud-hp-count').innerText = saveData.inventory.hpPot;
                    document.getElementById('hud-pwr-count').innerText = saveData.inventory.pwrPot;
                    document.getElementById('hud-dyn-count').innerText = saveData.inventory.dynamite;
                    document.getElementById('hud-weapon').innerText = texts[saveData.lang].wepName[currentWeapon];
                    const msg = document.getElementById('status-msg');
                    if(player.powerTimer > 0) { msg.style.display="block"; msg.innerText=texts[saveData.lang].status.power; msg.style.color="#ffeb3b"; }
                    else if(player.isHidden) { msg.style.display="block"; msg.innerText=texts[saveData.lang].status.stealth; msg.style.color="#81c784"; }
                    else msg.style.display="none";
                    const bossHud = document.getElementById('hud-boss');
                    if(boss) { bossHud.style.display = "block"; document.getElementById('boss-hp-bar').style.width = (boss.hp / boss.maxHp * 100) + "%"; } 
                    else { bossHud.style.display = "none"; }
                }
                else if(state.screen === 'GAMEOVER') {
                    if(state.kills > saveData.highScore) saveData.highScore = state.kills;
                    document.getElementById('game-over').classList.remove('hidden');
                    document.getElementById('go-money').innerText = state.sessionMoney;
                    document.getElementById('go-kills').innerText = state.kills;
                }
            }
        };

        function loop() {
            requestAnimationFrame(loop);
            const now = Date.now();
            const time = now * 0.0002;
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, "#ff8f00"); gradient.addColorStop(0.5, "#d84315"); gradient.addColorStop(1, "#4e342e");
            ctx.fillStyle = gradient; 
            ctx.fillRect(-50, -50, canvas.width+100, canvas.height+100);

            if(state.screen !== 'GAME' && state.screen !== 'GAMEOVER') {
                ctx.fillStyle = "rgba(0,0,0,0.2)"; decors.forEach(d => { ctx.font = d.size+"px Arial"; ctx.fillText(d.char, d.x, d.y); });
                ctx.globalAlpha = 0.6;
                menuObjects.forEach(o => {
                    o.x += o.spd; if(o.x > canvas.width + 50) o.x = -50;
                    ctx.drawImage((o.type==='cloud'?sprites.cloud:sprites.bird), o.x, o.y);
                });
                ctx.globalAlpha = 1.0;
                drawCrosshair(mouse.x, mouse.y, false);
                return;
            }

            if(state.screen === 'GAME') {
                ctx.save();
                if(state.shake > 0) {
                    ctx.translate(Math.random()*state.shake - state.shake/2, Math.random()*state.shake - state.shake/2);
                    state.shake *= 0.9; if(state.shake < 0.5) state.shake = 0;
                }

                ctx.fillStyle = "rgba(62, 39, 35, 0.5)"; decors.forEach(d => { ctx.font = d.size+"px Arial"; ctx.fillText(d.char, d.x, d.y); });

                let sens = Math.max(0.01, saveData.sensitivity); 
                aim.x += (mouse.x - aim.x) * sens; aim.y += (mouse.y - aim.y) * sens;

                let speed = player.spd;
                let fireRate = (currentWeapon === 'shotgun') ? 45 : Math.max(6, 20 - (saveData.upgrades.rate-1)*2);
                if(player.powerTimer > 0) { player.powerTimer--; speed += 3; fireRate = 5; if(player.powerTimer%60===0) Game.updateUI(); if(player.powerTimer<=0) Game.updateUI(); }
                if(keys.shift) speed *= 1.8;

                if(keys.w && player.y > 30) player.y -= speed; if(keys.s && player.y < canvas.height-30) player.y += speed;
                if(keys.a && player.x > 30) player.x -= speed; if(keys.d && player.x < canvas.width-30) player.x += speed;

                let inBush = false; bushes.forEach(b => { if(Math.hypot(player.x-b.x, player.y-b.y) < b.r) inBush = true; });
                if(player.revealTimer > 0) player.revealTimer--;
                const prevHidden = player.isHidden; player.isHidden = inBush && player.revealTimer <= 0;
                if(prevHidden !== player.isHidden) Game.updateUI();

                const angle = Math.atan2(aim.y - player.y, aim.x - player.x);
                if(crosshair.recoil > 0) crosshair.recoil -= 1;

                if(mouse.down && player.timer <= 0) {
                    player.revealTimer = 60;
                    if(currentWeapon === 'pistol') {
                        bullets.push({x:player.x, y:player.y, vx:Math.cos(angle)*7, vy:Math.sin(angle)*7, type:'pistol', dmg: player.dmg, pierce: player.pierce, hit:[]});
                        state.shake = 3; crosshair.recoil = 8;
                    } else {
                        for(let i=-2; i<=2; i++) {
                            let s = angle + i*0.1;
                            bullets.push({x:player.x, y:player.y, vx:Math.cos(s)*6, vy:Math.sin(s)*6, type:'shotgun', life:30, dmg: player.dmg, pierce: 1, hit:[]});
                        }
                        state.shake = 8; crosshair.recoil = 20;
                    }
                    player.timer = fireRate;
                }
                if(player.timer > 0) player.timer--;

                ctx.save(); ctx.translate(player.x, player.y);
                ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.ellipse(0,15,16,6,0,0,Math.PI*2); ctx.fill();
                if(player.powerTimer>0) { ctx.beginPath(); ctx.arc(0,0,35,0,Math.PI*2); ctx.fillStyle="rgba(255,235,0,0.3)"; ctx.fill(); }
                if(Math.abs(angle) > Math.PI/2) ctx.scale(1,-1);
                ctx.rotate(angle); ctx.drawImage(sprites.player, -50, -50);
                ctx.restore();
                if(!player.isHidden || player.revealTimer > 0) {
                    ctx.textAlign="center"; ctx.font="bold 14px monospace"; 
                    ctx.fillStyle="black"; ctx.fillText(saveData.nickname, player.x+1, player.y-60);
                    ctx.fillStyle="#ffeb3b"; ctx.fillText(saveData.nickname, player.x, player.y-61);
                }

                for(let i=dynamites.length-1; i>=0; i--) {
                    let d = dynamites[i]; d.timer--; ctx.drawImage(sprites.tnt, d.x-20, d.y-20);
                    if(d.timer <= 0) {
                        state.shake = 20; for(let k=0; k<20; k++) particles.push({x:d.x, y:d.y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, life:1, color:'orange'});
                        enemies.forEach(e => { if(Math.hypot(e.x-d.x, e.y-d.y) < 150) e.hp = 0; });
                        if(boss && Math.hypot(boss.x-d.x, boss.y-d.y) < 150) boss.hp -= 50;
                        dynamites.splice(i, 1);
                    } else if(d.timer % 10 < 5) { ctx.beginPath(); ctx.arc(d.x, d.y, 20, 0, Math.PI*2); ctx.fillStyle="rgba(255,0,0,0.5)"; ctx.fill(); }
                }

                if(!boss && state.kills > 0 && state.kills % 20 === 0) { boss = { x: -100, y: canvas.height/2, hp: 100, maxHp: 100, spd: 1.0, type: 'boss', shootTimer: 0 }; Game.updateUI(); }
                
                if(enemies.length < 30 && !boss && (now - lastSpawn > 1200 || enemies.length === 0)) {
                    lastSpawn = now;
                    let isShooter = Math.random() > 0.7;
                    const a = Math.random()*Math.PI*2; const r = Math.max(canvas.width, canvas.height)*0.7;
                    enemies.push({
                        x: canvas.width/2 + Math.cos(a)*r, y: canvas.height/2 + Math.sin(a)*r,
                        hp: 3 + Math.floor(state.sessionMoney/200),
                        spd: 1 + Math.random() * 1.5,
                        type: isShooter ? 'shooter' : 'chaser', shootTimer: Math.random() * 100
                    });
                }

                const allEnemies = boss ? [boss, ...enemies] : enemies;
                for(let i=allEnemies.length-1; i>=0; i--) {
                    let e = allEnemies[i];
                    let dist = Math.hypot(player.x - e.x, player.y - e.y);
                    let eAngle = Math.atan2(player.y - e.y, player.x - e.x);

                    if(player.isHidden && !boss) { e.x += Math.cos(now/500 + i)*0.5; e.y += Math.sin(now/500 + i)*0.5; } 
                    else {
                        if(e.type === 'shooter') { if(dist > 300) { e.x += Math.cos(eAngle)*e.spd; e.y += Math.sin(eAngle)*e.spd; } else { e.shootTimer--; if(e.shootTimer <= 0) { enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(eAngle)*5, vy:Math.sin(eAngle)*5}); e.shootTimer = 120; } } } 
                        else if (e.type === 'boss') { e.x += Math.cos(eAngle)*e.spd; e.y += Math.sin(eAngle)*e.spd; e.shootTimer--; if(e.shootTimer <= 0) { for(let k=-1; k<=1; k++) enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(eAngle+k*0.2)*6, vy:Math.sin(eAngle+k*0.2)*6}); e.shootTimer = 100; } } 
                        else { e.x += Math.cos(eAngle)*e.spd; e.y += Math.sin(eAngle)*e.spd; }
                    }

                    ctx.save(); ctx.translate(e.x, e.y); if(Math.abs(eAngle) > Math.PI/2) ctx.scale(1,-1); ctx.rotate(eAngle);
                    let sprite = sprites.enemy; if(e.type === 'shooter') sprite = sprites.shooter; if(e.type === 'boss') sprite = sprites.boss;
                    ctx.drawImage(sprite, -50, -50); ctx.restore();

                    if(dist < 40) {
                        if(e.type !== 'boss') { player.hp -= 10; enemies.splice(enemies.indexOf(e), 1); Game.updateUI(); if(player.hp<=0) {state.screen='GAMEOVER'; Game.updateUI(); return;} } 
                        else { player.hp -= 1; Game.updateUI(); }
                    }

                    for(let j=bullets.length-1; j>=0; j--) {
                        let b = bullets[j]; if(b.hit.includes(e)) continue;
                        if(Math.hypot(b.x-e.x, b.y-e.y) < (e.type==='boss'?60:40)) {
                            let dmg = (player.powerTimer>0 ? 100 : b.dmg); e.hp -= dmg; b.hit.push(e); b.pierce--;
                            for(let k=0; k<3; k++) particles.push({x:e.x, y:e.y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5, life:0.5, color:'#b71c1c'});
                            if(e.hp <= 0) {
                                if(e.type === 'boss') { boss = null; state.sessionMoney += 100; for(let k=0; k<20; k++) particles.push({x:e.x, y:e.y, vx:(Math.random()-0.5)*20, vy:(Math.random()-0.5)*20, life:2, color:'purple'}); } 
                                else { enemies.splice(enemies.indexOf(e), 1); state.sessionMoney += 5; }
                                state.kills++; Game.updateUI(); break;
                            }
                            if(b.pierce <= 0) bullets.splice(j, 1);
                        }
                    }
                }

                ctx.fillStyle = "red";
                for(let i=enemyBullets.length-1; i>=0; i--) {
                    let eb = enemyBullets[i]; eb.x += eb.vx; eb.y += eb.vy; ctx.beginPath(); ctx.arc(eb.x, eb.y, 6, 0, Math.PI*2); ctx.fill();
                    if(Math.hypot(eb.x-player.x, eb.y-player.y) < 30) { player.hp -= 10; state.shake = 5; Game.updateUI(); if(player.hp<=0) {state.screen='GAMEOVER'; Game.updateUI(); return;} enemyBullets.splice(i, 1); } 
                    else if(eb.x<0 || eb.x>canvas.width) enemyBullets.splice(i, 1);
                }

                ctx.globalAlpha = 0.85; bushes.forEach(b => { ctx.drawImage(sprites.bush, b.x - 50, b.y - 50); }); ctx.globalAlpha = 1.0;

                for(let i=bullets.length-1; i>=0; i--) {
                    let b = bullets[i]; b.x += b.vx; b.y += b.vy; if(b.type === 'shotgun') b.life--;
                    ctx.beginPath(); let size = (player.powerTimer>0 || b.dmg>1) ? 6 : 4; ctx.arc(b.x, b.y, size, 0, Math.PI*2); ctx.fillStyle = (player.powerTimer>0) ? "#ffff00" : "#212121"; ctx.fill();
                    if(b.x<-50 || b.x>canvas.width+50 || b.y<-50 || b.y>canvas.height+50 || (b.type==='shotgun' && b.life<=0)) bullets.splice(i, 1);
                }
                for(let i=particles.length-1; i>=0; i--) {
                    let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05; if(p.life<=0) { particles.splice(i, 1); continue; }
                    ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0;
                }

                ctx.restore(); 
                drawCrosshair(aim.x, aim.y, true);
            } 
            else if (state.screen === 'GAMEOVER') {
                ctx.fillStyle = "rgba(62, 39, 35, 0.5)"; decors.forEach(d => { ctx.font = d.size+"px Arial"; ctx.fillText(d.char, d.x, d.y); });
                ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(Math.atan2(aim.y-player.y, aim.x-player.x)); ctx.drawImage(sprites.player, -50, -50); ctx.restore();
                ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0,0,canvas.width, canvas.height);
            }
        }

        function drawCrosshair(x, y, isGame) {
            ctx.save(); ctx.translate(x, y);
            let size = isGame ? (10 + crosshair.recoil) : 10;
            ctx.strokeStyle = "rgba(255, 255, 255, 0.8)"; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0, 0, size, 0, Math.PI*2); ctx.stroke();
            ctx.fillStyle = "#ff3d00"; ctx.beginPath(); ctx.arc(0, 0, 3, 0, Math.PI*2); ctx.fill();
            if(isGame) {
                ctx.beginPath(); ctx.moveTo(-size-5, 0); ctx.lineTo(-size+2, 0); ctx.moveTo(size+5, 0); ctx.lineTo(size-2, 0);
                ctx.moveTo(0, -size-5); ctx.lineTo(0, -size+2); ctx.moveTo(0, size+5); ctx.lineTo(0, size-2); ctx.stroke();
            }
            ctx.restore();
        }

        Game.init();
    </script>
</body>
</html>